"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[115],{788(e,s,r){r.r(s),r.d(s,{assets:()=>a,contentTitle:()=>l,default:()=>d,frontMatter:()=>o,metadata:()=>t,toc:()=>c});var t=r(9471),n=r(4848),i=r(8453);const o={title:"Post 04 - PostgreSQL High Availability deployment on Kubernetes",excerpt:"In this post I will be covering details of deployment of PostgreSQL High Availability on Bare Metal VM's.",date:"2021-05-14 17:40:40 +0530",tags:["Kubernetes"]},l=void 0,a={authorsImageUrls:[]},c=[{value:"We need to modify values.yaml file or override below values using --set flag while installing helm:",id:"we-need-to-modify-valuesyaml-file-or-override-below-values-using---set-flag-while-installing-helm",level:4},{value:"Note : <em>Creating below Secret is important else you wont be able to reattach existing pv on next uninstall and reinstall of postgreSQL helm chart due to any reason.</em>",id:"note--creating-below-secret-is-important-else-you-wont-be-able-to-reattach-existing-pv-on-next-uninstall-and-reinstall-of-postgresql-helm-chart-due-to-any-reason",level:4},{value:"Important Steps to create Secret (don&#39;t miss this)",id:"important-steps-to-create-secret-dont-miss-this",level:4},{value:"Architecture of helm chart deployed",id:"architecture-of-helm-chart-deployed",level:3},{value:"<em>1) bitnami/postgresql-repmgr :</em>",id:"1-bitnamipostgresql-repmgr-",level:4},{value:"<em>2) bitnami/pgpool :</em>",id:"2-bitnamipgpool-",level:4},{value:"<em>For integration with harbor HA pass Pgpool Cluster IP as PG internally communicates to postgreSQL master and slave using headless service.</em>",id:"for-integration-with-harbor-ha-pass-pgpool-cluster-ip-as-pg-internally-communicates-to-postgresql-master-and-slave-using-headless-service",level:4}];function h(e){const s={a:"a",blockquote:"blockquote",br:"br",em:"em",h3:"h3",h4:"h4",hr:"hr",li:"li",ol:"ol",p:"p",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(s.p,{children:"In this post I will be covering details of deployment of PostgreSQL High Availability on Bare Metal VM's. This article is part of series of Harbor High Availability"}),"\n",(0,n.jsxs)(s.ol,{children:["\n",(0,n.jsxs)(s.li,{children:["\n",(0,n.jsxs)(s.p,{children:["Harbor High Availability deployment on Kubernetes ",(0,n.jsx)(s.br,{}),"\n",(0,n.jsx)(s.a,{href:"/blog/2021/05/14/Harbor%20High%20Availability%20deployment%20on%20Kubernetes",children:"Post 01 - Harbor High Availability deployment on Kubernetes"}),"\\"]}),"\n"]}),"\n",(0,n.jsxs)(s.li,{children:["\n",(0,n.jsxs)(s.p,{children:["Kubernetes Dynamic Provisioning : Persistent Volume on demand (Using helm charts) ",(0,n.jsx)(s.br,{}),"\n",(0,n.jsx)(s.a,{href:"/blog/2021/05/06/Dynamic%20Volume%20Provisioning%20NFS",children:"Kubernetes Dynamic Provisioning - Persistent Volume on demand (Using helm charts)"})," \\"]}),"\n"]}),"\n",(0,n.jsxs)(s.li,{children:["\n",(0,n.jsx)(s.p,{children:"High available Redis (Using helm charts)"}),"\n"]}),"\n",(0,n.jsxs)(s.li,{children:["\n",(0,n.jsx)(s.p,{children:"High available PostgreSQL database (Using helm charts) (this post)"}),"\n"]}),"\n",(0,n.jsxs)(s.li,{children:["\n",(0,n.jsx)(s.p,{children:"Harbor High Availability deployment in action on Kubernetes using helm chart."}),"\n"]}),"\n"]}),"\n",(0,n.jsxs)(s.blockquote,{children:["\n",(0,n.jsx)(s.p,{children:"PostgreSQL is an open source object-relational database known for its reliability and data integrity."}),"\n"]}),"\n",(0,n.jsx)(s.p,{children:(0,n.jsx)(s.strong,{children:"Prerequisite"})}),"\n",(0,n.jsxs)(s.ol,{children:["\n",(0,n.jsx)(s.li,{children:"Kubernetes cluster is up and running. To know how to achieve this read my previous post bootstrap kubernetes using kubeadm."}),"\n"]}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.a,{href:"/blog/2021/01/14/Kubernetes",children:"Bootstrap Kubernetes cluster with PV as NFS "})}),"\n"]}),"\n",(0,n.jsxs)(s.ol,{start:"2",children:["\n",(0,n.jsx)(s.li,{children:"NameSpace with name harbor-private-registry is already existing.\nIf its not created run:"}),"\n"]}),"\n",(0,n.jsx)(s.p,{children:"$ kubectl create ns harbor-private-registry"}),"\n",(0,n.jsxs)(s.ol,{start:"3",children:["\n",(0,n.jsx)(s.li,{children:"Dynamic Volume Provisioning NFS is working and able to create pv on demand."}),"\n"]}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.a,{href:"/blog/2021/05/06/Dynamic%20Volume%20Provisioning%20NFS",children:"Bootstrap Kubernetes cluster with PV as NFS "})}),"\n"]}),"\n",(0,n.jsx)(s.p,{children:(0,n.jsx)(s.em,{children:(0,n.jsx)(s.strong,{children:"Using helm chart for PostgreSQL High Availability cluster"})})}),"\n",(0,n.jsxs)(s.p,{children:["We will be using bitnami helm chart for deploying High Availabilty PostgreSQL cluster - ",(0,n.jsx)(s.a,{href:"https://github.com/bitnami/charts/tree/master/bitnami/postgresql-ha",children:"PostgreSQL helm"})]}),"\n",(0,n.jsx)(s.h4,{id:"we-need-to-modify-valuesyaml-file-or-override-below-values-using---set-flag-while-installing-helm",children:"We need to modify values.yaml file or override below values using --set flag while installing helm:"}),"\n",(0,n.jsx)(s.p,{children:(0,n.jsx)(s.em,{children:"--set pgpool.replicaCount=2"})}),"\n",(0,n.jsx)(s.p,{children:(0,n.jsx)(s.em,{children:"--set postgresql.replicaCount=3"})}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.em,{children:"--set postgresql.existingSecret=postgresql-harbor-secret"})," : Name of secret created to store postgreSQL and repmgr password"]}),"\n",(0,n.jsx)(s.p,{children:(0,n.jsx)(s.em,{children:"--set pgpool.adminPassword=MTk5MCRwb3N0Z3Jlc3Fs"})}),"\n",(0,n.jsx)(s.p,{children:(0,n.jsx)(s.em,{children:"--set pgpoolImage.tag=4.2.2-debian-10-r72"})}),"\n",(0,n.jsx)(s.p,{children:(0,n.jsx)(s.em,{children:"--set postgresqlImage.tag=13.2.0-debian-10-r77"})}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.em,{children:"--set global.storageClass=nfs-client"})," : Value (nfs-client) is name to storageClass created with NFS Dynamic Provisioner."]}),"\n",(0,n.jsx)(s.p,{children:(0,n.jsx)(s.em,{children:"--set service.type=ClusterIP"})}),"\n",(0,n.jsxs)(s.h4,{id:"note--creating-below-secret-is-important-else-you-wont-be-able-to-reattach-existing-pv-on-next-uninstall-and-reinstall-of-postgresql-helm-chart-due-to-any-reason",children:["Note : ",(0,n.jsx)(s.em,{children:"Creating below Secret is important else you wont be able to reattach existing pv on next uninstall and reinstall of postgreSQL helm chart due to any reason."})]}),"\n",(0,n.jsx)(s.h4,{id:"important-steps-to-create-secret-dont-miss-this",children:"Important Steps to create Secret (don't miss this)"}),"\n",(0,n.jsxs)(s.p,{children:["Create secret for configurable parameter of bitnami postgreSQL HA Helm chart values.yaml ",(0,n.jsx)(s.strong,{children:"postgresql.existingSecret"})]}),"\n",(0,n.jsx)(s.p,{children:"Create secret using below command and then install postgreSQL using helm chart:"}),"\n",(0,n.jsx)("script",{src:"https://gist.github.com/techslaves/a32ff5accc463cf68fba49f227588725.js"}),"\n",(0,n.jsx)(s.p,{children:"You will get below output on successfull installation of helm chart:"}),"\n",(0,n.jsx)(s.hr,{}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.em,{children:"NAME: postgresql-harbor-private-registry"})," ",(0,n.jsx)(s.br,{}),"\n",(0,n.jsx)(s.em,{children:"LAST DEPLOYED: Fri May  15 12:19:43 2021"})," ",(0,n.jsx)(s.br,{}),"\n",(0,n.jsx)(s.em,{children:"NAMESPACE: harbor-private-registry"})," ",(0,n.jsx)(s.br,{}),"\n",(0,n.jsx)(s.em,{children:"STATUS: deployed"})," ",(0,n.jsx)(s.br,{}),"\n",(0,n.jsx)(s.em,{children:"REVISION: 1"})," ",(0,n.jsx)(s.br,{}),"\n",(0,n.jsx)(s.em,{children:"TEST SUITE: None"})," ",(0,n.jsx)(s.br,{}),"\n",(0,n.jsx)(s.em,{children:"NOTES:"})," \\"]}),"\n",(0,n.jsx)(s.p,{children:(0,n.jsx)(s.em,{children:"Please be patient while the chart is being deployed"})}),"\n",(0,n.jsx)(s.p,{children:(0,n.jsx)(s.em,{children:"PostgreSQL can be accessed through Pgpool via port 5432 on the following DNS name from within your cluster:"})}),"\n",(0,n.jsx)(s.p,{children:(0,n.jsx)(s.em,{children:"postgresql-harbor-private-registry-pgpool.harbor.svc.cluster.local"})}),"\n",(0,n.jsx)(s.p,{children:(0,n.jsx)(s.em,{children:"Pgpool acts as a load balancer for PostgreSQL and forward read/write connections to the primary node while read-only connections are forwarded to standby nodes."})}),"\n",(0,n.jsx)(s.p,{children:(0,n.jsx)(s.em,{children:'To get the password for "postgres" run:'})}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.em,{children:'export POSTGRES_PASSWORD=$(kubectl get secret --namespace harbor-private-registry postgresql-harbor-private-registry-secret -o jsonpath="{.data.postgresql-password}"'})," | base64 --decode)\n",(0,n.jsx)(s.em,{children:'To get the password for "repmgr" run:'})]}),"\n",(0,n.jsx)(s.p,{children:(0,n.jsx)(s.em,{children:"--command -- psql -h postgresql-harbor-private-registry-pgpool -p 5432 -U postgres -d postgres"})}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.em,{children:"To connect to your database from outside the cluster execute the following commands:"}),"\n*psql -h 127.0.0.1 -p 5432 -U postgres -d postgres *"]}),"\n",(0,n.jsx)(s.hr,{}),"\n",(0,n.jsx)(s.p,{children:"Once the pods are up and running exec into postgreSQL stateful set pod and run *psql -h 127.0.0.1 -p 5432 -U postgres -d postgres *"}),"\n",(0,n.jsx)(s.p,{children:'Enter the password you get from *kubectl get secret --namespace harbor-private-registry postgresql-harbor-private-registry-secret -o jsonpath="{.data.postgresql-password}" | base64 --decode *'}),"\n",(0,n.jsx)(s.p,{children:"Create following database for harbor. Tables will be created automatically when Harbor HA starts"}),"\n",(0,n.jsx)(s.p,{children:"CREATE DATABASE notary_server;"}),"\n",(0,n.jsx)(s.p,{children:"CREATE DATABASE notary_signer;"}),"\n",(0,n.jsx)(s.p,{children:"CREATE DATABASE harbor_core;"}),"\n",(0,n.jsxs)(s.p,{children:["postgres-# \\l ",(0,n.jsx)(s.em,{children:"(this will list all the database)"})]}),"\n",(0,n.jsx)("script",{src:"https://gist.github.com/techslaves/b7bc2a5ea2a3c347324d375b6a49e04b.js"}),"\n",(0,n.jsx)(s.h3,{id:"architecture-of-helm-chart-deployed",children:"Architecture of helm chart deployed"}),"\n",(0,n.jsx)(s.p,{children:"Images used while deploying this helm chart:"}),"\n",(0,n.jsx)(s.h4,{id:"1-bitnamipostgresql-repmgr-",children:(0,n.jsx)(s.em,{children:"1) bitnami/postgresql-repmgr :"})}),"\n",(0,n.jsx)(s.p,{children:"PostgreSQL is an open source object-relational database known for its reliability and data integrity. This solution includes repmgr, an open-source tool for managing replication and failover on PostgreSQL clusters."}),"\n",(0,n.jsx)(s.h4,{id:"2-bitnamipgpool-",children:(0,n.jsx)(s.em,{children:"2) bitnami/pgpool :"})}),"\n",(0,n.jsx)(s.p,{children:"Pgpool-II is a PostgreSQL proxy. It stands between PostgreSQL servers and their clients providing connection pooling, load balancing, automated failover, and replication."}),"\n",(0,n.jsxs)(s.p,{children:["After you deploy PostgreSQL HA using helm chart it will deploy two Pod's of ",(0,n.jsx)(s.em,{children:"pgpool"})," and  three pods of ",(0,n.jsx)(s.em,{children:"postgresql-repmgr"}),"\npgpool is a deployment and postgresql-repmgr is a stateful set."]}),"\n",(0,n.jsx)(s.p,{children:"This will create one master and two slave cluster where Pgpool will be responsible for promoting slave to master incase master goes down."}),"\n",(0,n.jsx)(s.p,{children:"Master (pod/postgresql-harbor-postgresql-0) will be single point for write operation where as master and two slaves (pod/postgresql-harbor-postgresql-1 and pod/postgresql-harbor-postgresql-2) will be three point for read operation."}),"\n",(0,n.jsxs)(s.p,{children:["pod/postgresql-harbor-pgpool-23243g54f8-afdsc ",(0,n.jsx)(s.br,{}),"\n","pod/postgresql-harbor-pgpool-11834437d4-ojgfd  ",(0,n.jsx)(s.br,{}),"\n","pod/postgresql-harbor-postgresql-0 ",(0,n.jsx)(s.br,{}),"\n","pod/postgresql-harbor-postgresql-1  ",(0,n.jsx)(s.br,{}),"\n","pod/postgresql-harbor-postgresql-2"]}),"\n",(0,n.jsx)(s.p,{children:"Two Cluster IP service will be created and one headless service."}),"\n",(0,n.jsx)(s.p,{children:"PGPool pod's can be reached through pgpool cluster IP service and postgreSQL pods communicate to postgresql service."}),"\n",(0,n.jsx)(s.h4,{id:"for-integration-with-harbor-ha-pass-pgpool-cluster-ip-as-pg-internally-communicates-to-postgresql-master-and-slave-using-headless-service",children:(0,n.jsx)(s.em,{children:"For integration with harbor HA pass Pgpool Cluster IP as PG internally communicates to postgreSQL master and slave using headless service."})}),"\n",(0,n.jsxs)(s.p,{children:["In the next post I will be deploying Harbor Helm and details of Integration with Redis and PostgreSQL cluster - ",(0,n.jsx)(s.br,{}),"\n",(0,n.jsx)(s.a,{href:"/blog/2021/05/06/Dynamic%20Volume%20Provisioning%20NFS",children:"Kubernetes Dynamic Provisioning - Persistent Volume on demand (Using helm charts)"})]})]})}function d(e={}){const{wrapper:s}={...(0,i.R)(),...e.components};return s?(0,n.jsx)(s,{...e,children:(0,n.jsx)(h,{...e})}):h(e)}},8453(e,s,r){r.d(s,{R:()=>o,x:()=>l});var t=r(6540);const n={},i=t.createContext(n);function o(e){const s=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function l(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:o(e.components),t.createElement(i.Provider,{value:s},e.children)}},9471(e){e.exports=JSON.parse('{"permalink":"/blog/2021/05/15/PostgeSQL High Availability deployment on Kubernetes","editUrl":"https://github.com/techslaves/techslaves.github.io/tree/master/website/blog/2021-05-15-PostgeSQL High Availability deployment on Kubernetes.md","source":"@site/blog/2021-05-15-PostgeSQL High Availability deployment on Kubernetes.md","title":"Post 04 - PostgreSQL High Availability deployment on Kubernetes","description":"In this post I will be covering details of deployment of PostgreSQL High Availability on Bare Metal VM\'s. This article is part of series of Harbor High Availability","date":"2021-05-14T17:40:40.000Z","tags":[{"inline":true,"label":"Kubernetes","permalink":"/blog/tags/kubernetes"}],"readingTime":4.53,"hasTruncateMarker":false,"authors":[],"frontMatter":{"title":"Post 04 - PostgreSQL High Availability deployment on Kubernetes","excerpt":"In this post I will be covering details of deployment of PostgreSQL High Availability on Bare Metal VM\'s.","date":"2021-05-14 17:40:40 +0530","tags":["Kubernetes"]},"unlisted":false,"prevItem":{"title":"Post 01 - Harbor High Availability deployment on Kubernetes","permalink":"/blog/2021/05/14/Harbor High Availability deployment on Kubernetes"},"nextItem":{"title":"Post 02 - Kubernetes Dynamic Provisioning, Persistent Volume on demand (Using helm charts)","permalink":"/blog/2021/05/06/Dynamic Volume Provisioning NFS"}}')}}]);